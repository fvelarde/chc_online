from bokeh.plotting import figure, output_file, show
from bokeh.models import CustomJS, DatePicker, ColumnDataSource
from bokeh.layouts import column
import pandas as pd

# Load the data
def read_thref(file):
  df = pd.read_csv(file, sep=',', skiprows=1, na_values=['NaN', '-999.0'])
  df = df.drop([0,1])
  df = df.set_index(pd.DatetimeIndex(df['TIMESTAMP']))
  df.index.names = ['date']
  df = df.drop('TIMESTAMP', axis=1)
  df = df.astype(float)
  return df

# Load the data
file_thref = "/home/fhertop/THref/data/20240527/THref_TH_1min_terraza.dat"
data = read_thref(file_thref)

# Create a date picker
date_picker = DatePicker(title='Select date', value="2024-05-22", min_date="2024-05-01", max_date="2026-10-30")

# Create a ColumnDataSource for the data
source = ColumnDataSource(data)

# Create a figure for the plot
plot = figure(title="Time Series", x_axis_label='Date', y_axis_label='Temperature')

# Add the data to the plot
plot.line(x='date', y='R1_T_Avg', source=source)

# Define the custom JavaScript callback
date_picker.js_on_change("value", CustomJS(args=dict(source=source, plot=plot), code="""
var date = cb_obj.value;
var data = source.data;
var filtered_data = data['R1_T_Avg'][data.index.format('YYYY-MM-DD') == date];
var filtered_index = data.index[data.index.format('YYYY-MM-DD') == date];

// Update data in-place
data['date'] = filtered_index;
data['R1_T_Avg'] = filtered_data;

// Update the plot (not necessary for Bokeh 2.4.3)
// plot.x_range.start = filtered_index.min();
// plot.x_range.end = filtered_index.max();
"""))

# Set the output file name
output_file("time_series.html")

# Create a layout
layout = column(date_picker, plot)

# Show the plot
show(layout)
